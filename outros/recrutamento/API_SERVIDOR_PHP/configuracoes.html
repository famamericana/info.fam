<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recrutamento RH - Configurações</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="code/style.css">
</head>
<body>
    <header>
        <h1><i class="fas fa-cog"></i> Configurações</h1>
        <p>FAM - Faculdade de Americana</p>
    </header>

    <div class="vagas-section active">
        <div class="container">
            <div class="user-info">
                <div class="user-info-text">
                    <strong id="userName"></strong>
                    <span id="userEmail"></span>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="voltarPainel()">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>

            <div id="alertContainer"></div>

            <div class="settings-container">
                <div class="settings-section">
                    <h2><i class="fas fa-key"></i> Alterar Senha</h2>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label for="senhaAtual">Senha Atual: *</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="senhaAtual" required minlength="6">
                                <button type="button" class="toggle-password" onclick="togglePassword('senhaAtual')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="senhaNova">Nova Senha: *</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="senhaNova" required minlength="6">
                                <button type="button" class="toggle-password" onclick="togglePassword('senhaNova')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="password-strength">
                                <div class="strength-bar">
                                    <div class="strength-bar-fill" id="strengthBar"></div>
                                </div>
                                <span id="strengthText"></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="senhaConfirmar">Confirmar Nova Senha: *</label>
                            <div class="password-input-wrapper">
                                <input type="password" id="senhaConfirmar" required minlength="6">
                                <button type="button" class="toggle-password" onclick="togglePassword('senhaConfirmar')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Salvar Nova Senha
                        </button>
                    </form>
                </div>

                <div class="settings-section">
                    <h2><i class="fas fa-user"></i> Informações do Perfil</h2>
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <strong><i class="fas fa-user"></i> Nome:</strong>
                            <span id="profileNome"></span>
                        </div>
                        <div class="profile-info-item">
                            <strong><i class="fas fa-envelope"></i> E-mail:</strong>
                            <span id="profileEmail"></span>
                        </div>
                        <div class="profile-info-item">
                            <strong><i class="fas fa-shield-alt"></i> Tipo de Conta:</strong>
                            <span id="profileTipo"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAÇÃO
        const API_URL = 'https://famamericana.com.br/recrutamento/api';
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        let isUserAdmin = localStorage.getItem('isUserAdmin') === '1';

        // Verificar autenticação
        if (!authToken || !currentUser.id) {
            window.location.href = 'painel-admin.html';
        }

        // Carregar informações do usuário
        document.getElementById('userName').textContent = currentUser.nome;
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('profileNome').textContent = currentUser.nome;
        document.getElementById('profileEmail').textContent = currentUser.email;
        document.getElementById('profileTipo').innerHTML = isUserAdmin 
            ? '<span class="badge" style="background: var(--info); color: white;"><i class="fas fa-crown"></i> Administrador</span>'
            : '<span class="badge" style="background: var(--primary); color: white;"><i class="fas fa-user"></i> Usuário</span>';

        // Toggle visibilidade da senha
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = event.currentTarget.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Verificar força da senha
        document.getElementById('senhaNova').addEventListener('input', (e) => {
            const senha = e.target.value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');
            
            if (senha.length < 6) {
                strengthBar.className = 'strength-bar-fill';
                strengthText.textContent = '';
                return;
            }
            
            let strength = 0;
            if (senha.length >= 8) strength++;
            if (/[a-z]/.test(senha) && /[A-Z]/.test(senha)) strength++;
            if (/\d/.test(senha)) strength++;
            if (/[^a-zA-Z0-9]/.test(senha)) strength++;
            
            strengthBar.className = 'strength-bar-fill';
            if (strength <= 1) {
                strengthBar.classList.add('strength-weak');
                strengthText.textContent = 'Fraca';
                strengthText.style.color = 'var(--danger)';
            } else if (strength <= 2) {
                strengthBar.classList.add('strength-medium');
                strengthText.textContent = 'Média';
                strengthText.style.color = 'var(--warning)';
            } else {
                strengthBar.classList.add('strength-strong');
                strengthText.textContent = 'Forte';
                strengthText.style.color = 'var(--success)';
            }
        });

        // Submeter formulário de alteração de senha
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const senhaAtual = document.getElementById('senhaAtual').value;
            const senhaNova = document.getElementById('senhaNova').value;
            const senhaConfirmar = document.getElementById('senhaConfirmar').value;
            
            // Validar senhas
            if (senhaNova !== senhaConfirmar) {
                mostrarAlerta('As senhas não coincidem', 'error');
                return;
            }
            
            if (senhaNova.length < 6) {
                mostrarAlerta('A senha deve ter no mínimo 6 caracteres', 'error');
                return;
            }
            
            if (senhaNova === senhaAtual) {
                mostrarAlerta('A nova senha deve ser diferente da senha atual', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/alterar-senha`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        usuario_id: currentUser.id,
                        senha_atual: senhaAtual,
                        senha_nova: senhaNova
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    mostrarAlerta('Senha alterada com sucesso!', 'success');
                    document.getElementById('passwordForm').reset();
                    document.getElementById('strengthBar').className = 'strength-bar-fill';
                    document.getElementById('strengthText').textContent = '';
                } else {
                    mostrarAlerta(data.error, 'error');
                }
            } catch (error) {
                mostrarAlerta('Erro ao alterar senha', 'error');
            }
        });

        function mostrarAlerta(mensagem, tipo) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${tipo}">${mensagem}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function voltarPainel() {
            window.location.href = 'painel-admin.html';
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isUserAdmin');
            window.location.href = 'painel-admin.html';
        }
    </script>
</body>
</html>
