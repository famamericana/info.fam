// CONFIGURA√á√ÉO - Substitua pelos seus valores
const CONFIG = {
  planilhaNome: 'Sacochila Leads - FA 2025' // Nome da sua planilha no Google Drive
};

// Cache para IDs
let cache = {
  spreadsheetIds: {}
};

/**
 * Fun√ß√£o para obter o ID de uma planilha pelo nome
 */
function getSpreadsheetIdByName(sheetName) {
  if (cache.spreadsheetIds[sheetName]) {
    console.log(`[CACHE] Planilha '${sheetName}' encontrada no cache`);
    return cache.spreadsheetIds[sheetName];
  }

  try {
    const files = DriveApp.getFilesByName(sheetName);
    let fileId = null;
    
    while (files.hasNext()) {
      const file = files.next();
      if (file.getMimeType() === 'application/vnd.google-apps.spreadsheet') {
        fileId = file.getId();
        console.log(`[ENCONTRADO] Planilha '${sheetName}' com ID: ${fileId}`);
        break;
      }
    }

    if (fileId) {
      cache.spreadsheetIds[sheetName] = fileId;
      return fileId;
    } else {
      console.error(`[ERRO] Planilha '${sheetName}' n√£o encontrada`);
      return null;
    }
  } catch (error) {
    console.error('[ERRO] Exce√ß√£o ao buscar planilha:', error.toString());
    return null;
  }
}

/**
 * Fun√ß√£o para garantir que a planilha tenha os cabe√ßalhos corretos
 */
function ensureHeaders(sheet, headers) {
  const cellA1Value = sheet.getRange('A1').getValue();
  const hasHeaders = cellA1Value !== '';

  if (!hasHeaders) {
    console.log(`Inserindo cabe√ßalhos na planilha`);
    
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setValues([headers]);
    
    // Formata√ß√£o dos cabe√ßalhos
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#4285f4');
    headerRange.setFontColor('#ffffff');
    headerRange.setBorder(true, true, true, true, true, true);
    
    SpreadsheetApp.flush();
    console.log(`Cabe√ßalhos inseridos com sucesso`);
  } else {
    // Verifica se os cabe√ßalhos existentes est√£o corretos
    const existingHeaders = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    console.log('Cabe√ßalhos existentes:', existingHeaders);
    
    // Se os cabe√ßalhos n√£o correspondem, atualiza APENAS a primeira linha de cabe√ßalhos
    // N√ÉO limpar a planilha inteira ‚Äî isso evita perder todos os dados (problema em linhas > 3000)
    if (existingHeaders.join('|') !== headers.join('|')) {
      console.log('Cabe√ßalhos n√£o correspondem. Atualizando apenas a primeira linha de cabe√ßalhos (sem limpar dados)...');

      // Sobrescreve somente a primeira linha com os novos cabe√ßalhos.
      // Isso preserva todos os registros j√° existentes na planilha.
      const headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setValues([headers]);

      // Formata√ß√£o dos cabe√ßalhos (mesma formata√ß√£o anterior)
      headerRange.setFontWeight('bold');
      headerRange.setBackground('#4285f4');
      headerRange.setFontColor('#ffffff');
      headerRange.setBorder(true, true, true, true, true, true);

      SpreadsheetApp.flush();
      console.log('Cabe√ßalhos atualizados com sucesso (sem limpar dados)');
    }
  }
}

/**
 * Fun√ß√£o principal para receber dados do formul√°rio
 */
function doPost(e) {
  console.log('[doPost] Iniciando processamento');
  
  try {
    // Verifica se h√° dados POST
    if (!e || !e.postData || !e.postData.contents) {
      throw new Error('Nenhum dado POST recebido');
    }
    
    const formData = JSON.parse(e.postData.contents);
    console.log('Dados recebidos:', JSON.stringify(formData, null, 2));

    // Busca ou cria a planilha
    let spreadsheetId = getSpreadsheetIdByName(CONFIG.planilhaNome);
    
    if (!spreadsheetId) {
      // Cria nova planilha se n√£o existir
      console.log('Criando nova planilha...');
      const newSpreadsheet = SpreadsheetApp.create(CONFIG.planilhaNome);
      spreadsheetId = newSpreadsheet.getId();
      cache.spreadsheetIds[CONFIG.planilhaNome] = spreadsheetId;
    }

    const ss = SpreadsheetApp.openById(spreadsheetId);
    let sheet = ss.getActiveSheet();

    // Define os cabe√ßalhos na ordem CORRETA (com a nova coluna Escola)
    const headers = [
      'ID', 
      'Data/Hora', 
      'CPF', 
      'E-mail', 
      'Nome Completo', 
      'Celular', 
      'Escola',
      'Cursos Favoritos', 
      'Modalidade Preferida',
      'Status', 
      'Data Confirma√ß√£o'
    ];
    
    // Garante que os cabe√ßalhos existam e estejam corretos
    ensureHeaders(sheet, headers);

    // Gera um ID √∫nico para este registro
    const uniqueId = Utilities.getUuid().substring(0, 8);
    const timestamp = new Date();

    // Prepara os dados para inserir na ordem CORRETA (com a nova coluna Escola)
    const rowData = [
      uniqueId, // ID (coluna A)
      timestamp, // Data/Hora (coluna B)
      formData.cpf || '', // CPF (coluna C)
      formData.email || '', // E-mail (coluna D)
      formData.nomeCompleto || '', // Nome Completo (coluna E)
      formData.celular || '', // Celular (coluna F)
      formData.escola || '', // Escola (coluna G)
      Array.isArray(formData.cursosFavoritos) ? formData.cursosFavoritos.join(', ') : formData.cursosFavoritos || '', // Cursos Favoritos (coluna H)
      formData.modalidade || '', // Modalidade Preferida (coluna I)
      'PENDENTE', // Status (coluna J)
      '' // Data Confirma√ß√£o (coluna K)
    ];

    // Adiciona os dados √† planilha
    const newRow = sheet.appendRow(rowData);
    const rowIndex = sheet.getLastRow();
    
    // Colore a linha de vermelho (status pendente)
    const range = sheet.getRange(rowIndex, 1, 1, headers.length);
    range.setBackground('#ffebee'); // Vermelho claro
    
    SpreadsheetApp.flush();
    console.log('Dados inseridos na planilha na linha:', rowIndex);

    console.log('Processamento conclu√≠do com sucesso');
    
    return ContentService
      .createTextOutput(JSON.stringify({ 
        'result': 'success', 
        'message': 'Formul√°rio enviado com sucesso!',
        'id': uniqueId,
        'rowNumber': rowIndex
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    console.error('Erro:', error.toString());
    
    return ContentService
      .createTextOutput(JSON.stringify({ 
        'result': 'error', 
        'message': error.toString() 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Fun√ß√£o para confirmar um registro via ID
 */
function doGet(e) {
  console.log('[doGet] Iniciando processamento de confirma√ß√£o');
  
  try {
    const id = e.parameter.id;
    
    if (!id) {
      return ContentService
        .createTextOutput(JSON.stringify({ 
          'result': 'error', 
          'message': 'ID n√£o fornecido' 
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    console.log(`[doGet] Processando confirma√ß√£o para ID: ${id}`);

    const spreadsheetId = getSpreadsheetIdByName(CONFIG.planilhaNome);
    
    if (!spreadsheetId) {
      throw new Error('Planilha n√£o encontrada');
    }

    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheet = ss.getActiveSheet();
    
    // Busca o registro pelo ID
    const data = sheet.getDataRange().getValues();
    console.log(`[doGet] Buscando ID '${id}' em ${data.length} linhas`);
    
    for (let i = 1; i < data.length; i++) { // Come√ßa do 1 para pular cabe√ßalho
      if (data[i][0] === id) { // Coluna A (√≠ndice 0) cont√©m o ID
        const rowIndex = i + 1;
        console.log(`[doGet] ID encontrado na linha ${rowIndex}`);
        
        // Verifica se j√° est√° confirmado
        const currentStatus = data[i][9]; // Coluna J (Status) - √≠ndice 9
        const confirmationDate = data[i][10]; // Coluna K (Data Confirma√ß√£o) - √≠ndice 10
        
        if (currentStatus === 'CONFIRMADO') {
          console.log('[doGet] Cadastro j√° confirmado anteriormente');
          
          // Retorna os dados do usu√°rio com status de j√° confirmado
          const userData = {
            id: data[i][0],
            dataHora: data[i][1],
            cpf: data[i][2],
            email: data[i][3],
            nomeCompleto: data[i][4],
            celular: data[i][5],
            escola: data[i][6], // Nova coluna Escola
            cursosFavoritos: data[i][7],
            modalidade: data[i][8],
            status: 'CONFIRMADO',
            dataConfirmacao: confirmationDate
          };
          
          return ContentService
            .createTextOutput(JSON.stringify({ 
              'result': 'success', 
              'message': 'Cadastro j√° confirmado anteriormente',
              'userData': userData,
              'alreadyConfirmed': true,
              'rowNumber': rowIndex
            }))
            .setMimeType(ContentService.MimeType.JSON);
        }
        
        // Atualiza status e data de confirma√ß√£o apenas se n√£o estiver confirmado
        sheet.getRange(rowIndex, 10).setValue('CONFIRMADO'); // Coluna J (Status)
        const now = new Date();
        sheet.getRange(rowIndex, 11).setValue(now);   // Coluna K (Data Confirma√ß√£o)
        
        // Muda cor da linha para verde
        const range = sheet.getRange(rowIndex, 1, 1, 11);
        range.setBackground('#e8f5e8'); // Verde claro
        
        SpreadsheetApp.flush();
        console.log('[doGet] Cadastro confirmado com sucesso');
        
        // Retorna os dados do usu√°rio
        const userData = {
          id: data[i][0],
          dataHora: data[i][1],
          cpf: data[i][2],
          email: data[i][3],
          nomeCompleto: data[i][4],
          celular: data[i][5],
          escola: data[i][6], // Nova coluna Escola
          cursosFavoritos: data[i][7],
          modalidade: data[i][8],
          status: 'CONFIRMADO',
          dataConfirmacao: now
        };
        
        return ContentService
          .createTextOutput(JSON.stringify({ 
            'result': 'success', 
            'message': 'Cadastro confirmado com sucesso!',
            'userData': userData,
            'alreadyConfirmed': false,
            'rowNumber': rowIndex
          }))
          .setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    // Se chegou aqui, n√£o encontrou o ID
    console.log(`[doGet] ID '${id}' n√£o encontrado`);
    return ContentService
      .createTextOutput(JSON.stringify({ 
        'result': 'error', 
        'message': 'Cadastro n√£o encontrado' 
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('[doGet] Erro ao confirmar:', error.toString());
    
    return ContentService
      .createTextOutput(JSON.stringify({ 
        'result': 'error', 
        'message': error.toString() 
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Fun√ß√£o para implantar o Web App
 */
function deployAsWebApp() {
  console.log("INSTRU√á√ïES DE IMPLANTA√á√ÉO:");
  console.log("1. V√° em 'Implantar' -> 'Nova implanta√ß√£o'");
  console.log("2. Tipo: Web App");
  console.log("3. Execute como: Sua cuenta");
  console.log("4. Quem tem acesso: Qualquer pessoa");
  console.log("5. Copie a URL gerada e use no seu formul√°rio HTML");
}

/**
 * FUN√á√ÉO DE TESTE 1: Testar doPost
 */
function testeDoPost() {
  console.log("=== INICIANDO TESTE DO doPost ===");
  
  const mockEvent = {
    postData: {
      contents: JSON.stringify({
        cpf: '123.456.789-00',
        email: 'teste@exemplo.com',
        nomeCompleto: 'Jo√£o Silva Teste',
        celular: '(11) 99999-8888'
      })
    }
  };

  try {
    const resultado = doPost(mockEvent);
    const content = resultado.getContent();
    console.log("‚úÖ doPost executou com sucesso!");
    console.log("üìÑ Resposta:", content);
    
    // Tenta fazer parse do JSON para verificar se est√° v√°lido
    const jsonResult = JSON.parse(content);
    console.log("‚úÖ JSON v√°lido:", jsonResult);
    
    if (jsonResult.result === 'success') {
      console.log("üéØ ID gerado:", jsonResult.id);
    }
    
  } catch (error) {
    console.error("‚ùå Erro no teste doPost:", error.toString());
    console.error("üìç Stack:", error.stack);
  }
  
  console.log("=== FIM TESTE doPost ===");
}

/**
 * FUN√á√ÉO DE TESTE 2: Testar doGet
 */
function testeDoGet() {
  console.log("=== INICIANDO TESTE DO doGet ===");
  
  // Primeiro, vamos criar um registro para testar
  console.log("1. Criando registro de teste...");
  testeDoPost();
  
  // Aguarda um pouco para o registro ser criado
  Utilities.sleep(1000);
  
  // Pega o √∫ltimo ID da planilha
  try {
    const spreadsheetId = getSpreadsheetIdByName(CONFIG.planilhaNome);
    if (!spreadsheetId) {
      throw new Error("Planilha n√£o encontrada para teste");
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetId);
    const sheet = ss.getActiveSheet();
    const lastRow = sheet.getLastRow();
    
    if (lastRow <= 1) {
      throw new Error("Nenhum registro encontrado para testar");
    }
    
    const testId = sheet.getRange(lastRow, 1).getValue(); // Pega o ID da √∫ltima linha
    console.log("2. Testando confirma√ß√£o com ID:", testId);
    
    const mockGetEvent = {
      parameter: {
        id: testId
      }
    };
    
    const resultado = doGet(mockGetEvent);
    const content = resultado.getContent();
    console.log("‚úÖ doGet executou com sucesso!");
    console.log("üìÑ Resposta:", content);
    
    // Verifica se o JSON √© v√°lido
    const jsonResult = JSON.parse(content);
    console.log("‚úÖ JSON v√°lido:", jsonResult);
    
    if (jsonResult.result === 'success') {
      console.log("üéØ Dados do usu√°rio:", jsonResult.userData);
    }
    
  } catch (error) {
    console.error("‚ùå Erro no teste doGet:", error.toString());
    console.error("üìç Stack:", error.stack);
  }
  
  console.log("=== FIM TESTE doGet ===");
}

/**
 * FUN√á√ÉO DE TESTE 3: Verificar configura√ß√µes
 */
function testeConfiguracoes() {
  console.log("=== VERIFICANDO CONFIGURA√á√ïES ===");
  
  console.log("üìã CONFIG atual:");
  console.log("  - planilhaNome:", CONFIG.planilhaNome);
  
  // Testa se consegue encontrar/criar a planilha
  try {
    let spreadsheetId = getSpreadsheetIdByName(CONFIG.planilhaNome);
    
    if (!spreadsheetId) {
      console.log("üìù Planilha n√£o existe. Tentando criar...");
      const newSpreadsheet = SpreadsheetApp.create(CONFIG.planilhaNome);
      spreadsheetId = newSpreadsheet.getId();
      console.log("‚úÖ Planilha criada com ID:", spreadsheetId);
    } else {
      console.log("‚úÖ Planilha encontrada com ID:", spreadsheetId);
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetId);
    console.log("‚úÖ Planilha aberta:", ss.getName());
    console.log("üìä URL da planilha:", ss.getUrl());
    
  } catch (error) {
    console.error("‚ùå Erro ao acessar planilha:", error.toString());
  }
  
  console.log("=== FIM VERIFICA√á√ÉO ===");
}

/**
 * FUN√á√ÉO DE TESTE 4: Teste completo
 */
function testeCompleto() {
  console.log("üöÄ INICIANDO TESTE COMPLETO DO SISTEMA");
  console.log("=====================================");
  
  // Teste 1: Configura√ß√µes
  testeConfiguracoes();
  
  console.log("\n");
  
  // Teste 2: doPost
  testeDoPost();
  
  console.log("\n");
  
  // Teste 3: doGet
  testeDoGet();
  
  console.log("\nüéâ TESTE COMPLETO FINALIZADO!");
  console.log("Verifique os logs acima para identificar problemas.");
}

/**
 * FUN√á√ÉO DE TESTE 5: Simular requisi√ß√£o HTTP
 */
function testeHTTP() {
  console.log("=== TESTE DE REQUISI√á√ÉO HTTP ===");
  
  const url = ScriptApp.getService().getUrl();
  console.log("üì° URL do Web App:", url);
  
  try {
    // Simula POST
    const postPayload = JSON.stringify({
      cpf: '123.456.789-00',
      email: 'teste@http.com',
      nomeCompleto: 'Teste HTTP',
      celular: '(11) 88888-7777'
    });
    
    const postOptions = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      payload: postPayload
    };
    
    console.log("üì§ Enviando POST para:", url);
    const postResponse = UrlFetchApp.fetch(url, postOptions);
    console.log("‚úÖ Resposta POST:", postResponse.getContentText());
    
  } catch (error) {
    console.error("‚ùå Erro no teste HTTP:", error.toString());
  }
  
  console.log("=== FIM TESTE HTTP ===");
}